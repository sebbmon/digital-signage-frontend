<div class="container-fluid media-page-container p-3 p-md-4">
  
  <div class="row mb-4 align-items-center">
    <div class="col-12">
      <h2 class="fw-bold text-dark mb-1">Playlisty</h2>
      <p class="text-muted small mb-0">Twórz i zarządzaj listami odtwarzania.</p>
    </div>
  </div>

  <div class="row g-4 align-items-start">
    
    <div class="col-lg-6 col-md-12">
      <div class="card border-0 strong-shadow rounded-4 h-100">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-3">Nowa playlista</h5>
          
          <form (ngSubmit)="addPlaylist()">
            <div class="d-flex flex-column gap-3">
              
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label small text-muted text-uppercase fw-bold">Nazwa</label>
                  <input type="text" class="form-control modern-input" [(ngModel)]="playlistName" name="playlistName" placeholder="Np. Reklama UKEN">
                </div>

                <div class="col-md-6">
                  <label class="form-label small text-muted text-uppercase fw-bold">Opis</label>
                  <input type="text" class="form-control modern-input" [(ngModel)]="playlistDesc" name="playlistDesc" placeholder="Opcjonalny opis">
                </div>
              </div>

              <div>
                <label class="form-label small text-muted text-uppercase fw-bold d-flex justify-content-between">
                  Wybierz media
                  <span class="badge bg-light text-dark border">{{ selectedMediaMap.size }} wybranych</span>
                </label>
                
                <div class="media-selection-list custom-scrollbar">
                  <div class="media-selection-item" 
                       *ngFor="let m of mediaList"
                       [class.selected]="isMediaSelected(m.id)"
                       (click)="toggleMediaSelection(m.id)">
                    
                    <div class="form-check pointer-events-none"> 
                        <input class="form-check-input" type="checkbox" [checked]="isMediaSelected(m.id)">
                    </div>

                    <div class="media-icon-placeholder rounded-3 d-flex align-items-center justify-content-center flex-shrink-0 ms-2"
                         style="width: 32px; height: 32px; font-size: 1rem;"
                         [ngClass]="m.contentType.startsWith('video') ? 'bg-primary-subtle text-primary' : 'bg-success-subtle text-success'">
                      <i class="bi" [ngClass]="m.contentType.startsWith('video') ? 'bi-play-circle-fill' : 'bi-image'"></i>
                    </div>

                    <div class="flex-grow-1 ms-3 overflow-hidden d-flex align-items-center justify-content-between pe-2">
                      <div style="min-width: 0;">
                          <div class="fw-semibold text-truncate small">{{ m.originalName }}</div>
                          <div class="text-muted text-truncate" style="font-size: 0.75rem;">
                              {{ formatSize(m.size) }} • {{ m.uploadedAt | date:'dd.MM' }}
                          </div>
                      </div>

                      <div *ngIf="isMediaSelected(m.id)" 
                           (click)="$event.stopPropagation()" 
                           class="d-flex align-items-center ms-2 animate-fade-in">
                        <input type="number" 
                               class="form-control form-control-sm modern-input text-center px-1" 
                               style="width: 60px; height: 28px; font-size: 0.8rem;"
                               placeholder="Auto"
                               min="1"
                               [ngModel]="getMediaDuration(m.id)"
                               (ngModelChange)="updateMediaDuration(m.id, $event)"
                               [ngModelOptions]="{standalone: true}">
                        <span class="text-muted ms-1 small" style="font-size: 0.7rem;">s</span>
                      </div>
                    </div>

                    <button type="button" class="btn btn-sm btn-light text-secondary ms-1" 
                            (click)="previewMedia(m); $event.stopPropagation()" title="Szybki podgląd">
                      <i class="bi bi-eye"></i>
                    </button>
                  </div>
                  
                  <div *ngIf="mediaList.length === 0" class="text-center text-muted py-4 small">
                    Brak mediów w bibliotece.
                  </div>
                </div>
                <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">Kliknij element, aby dodać go do playlisty.</small>
              </div>

              <div *ngIf="addError" class="alert alert-danger py-2 small mb-0">
                <i class="bi bi-exclamation-circle me-1"></i> {{ addError }}
              </div>

              <div class="d-flex gap-2 mt-2 pt-3 border-top">
                <button type="reset" class="btn btn-light text-muted flex-fill"
                        (click)="playlistName=''; playlistDesc=''; selectedMediaMap.clear(); addError=''">
                  Wyczyść
                </button>
                <button type="submit" class="btn btn-primary flex-fill">
                  <i class="bi bi-plus-lg me-1"></i> Utwórz
                </button>
              </div>

            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-6 col-md-12">
      <div class="card border-0 strong-shadow rounded-4 overflow-hidden">
        
        <div class="table-responsive playlist-scroll-container">
          
          <table class="table table-hover align-middle mb-0 modern-table fixed-table">
            
            <thead class="bg-light text-secondary text-uppercase small">
              <tr>
                <th class="ps-4" style="width: 30%;">Nazwa</th>
                <th class="d-none d-md-table-cell" style="width: auto;">Opis</th>
                <th style="width: 100px;" class="text-center">Media</th>
                <th class="text-end pe-4" style="width: 120px;">Akcje</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let playlist of playlists">
                <td class="ps-4">
                  <div class="d-flex align-items-center gap-3">
                    <div class="media-icon-placeholder bg-warning-subtle text-warning rounded-3 d-flex align-items-center justify-content-center flex-shrink-0">
                      <i class="bi bi-music-note-list"></i>
                    </div>
                    <span class="fw-semibold text-dark text-truncate">{{ playlist.name }}</span>
                  </div>
                </td>
                
                <td class="d-none d-md-table-cell">
                  <span class="text-muted small text-truncate d-block" style="max-width: 250px;">
                    {{ playlist.description || '-' }}
                  </span>
                </td>

                <td class="text-center">
                  <span class="badge bg-light text-dark border rounded-pill px-3">
                    {{ playlist.files.length }}
                  </span>
                </td>

                <td class="text-end pe-4">
                  <div class="btn-group shadow-sm rounded-3">
                    <button class="btn btn-sm btn-light text-dark" (click)="openEditModal(playlist)" title="Edytuj">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-light text-danger" (click)="openDeleteModal(playlist.id)" title="Usuń playliste">
                      <i class="bi bi-trash3"></i>
                    </button>
                  </div>
                </td>
              </tr>

              <tr *ngIf="playlists.length === 0">
                <td colspan="4" class="text-center py-5">
                  <div class="d-flex flex-column align-items-center text-muted">
                    <i class="bi bi-music-note-list display-4 mb-3 text-secondary opacity-50"></i>
                    <p>Brak playlist. Utwórz pierwszą po lewej stronie.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- pop up podgladu mediow -->
<div class="modal fade show"
     *ngIf="showPreview"
     [ngStyle]="{ display: 'block', background: 'rgba(0,0,0,0.5)' }"
     (click)="closePreview()">

  <div class="modal-dialog modal-dialog-centered media-shrink-modal"
       (click)="$event.stopPropagation()">

    <div class="modal-content preview-window">
      
      <div class="modal-header d-flex align-items-center gap-2">
        
        <div class="flex-shrink-0 d-flex text-secondary">
           <ng-container *ngIf="selectedMedia?.contentType?.startsWith('video'); else imageIcon">
             <i class="bi bi-camera-video text-primary fs-5"></i>
           </ng-container>
           <ng-template #imageIcon>
             <i class="bi bi-image text-success fs-5"></i>
           </ng-template>
        </div>

        <div class="header-text-constraint d-flex flex-column justify-content-center">
             <div class="fw-bold text-truncate" [title]="selectedMedia?.filename">
               {{ selectedMedia?.filename }}
             </div>
             <div class="text-muted small text-truncate fw-normal">
               {{ selectedMedia?.originalName }}
             </div>
        </div>

        <button type="button" class="btn-close flex-shrink-0 ms-1" (click)="closePreview()"></button>
      </div>

      <div class="modal-body p-0 d-flex justify-content-center align-items-center bg-light rounded-2 overflow-hidden">

        <ng-container *ngIf="selectedMedia?.contentType?.startsWith('video')">
          <div *ngIf="!videoLoaded" class="loader-container">
            <div class="spinner-border text-primary" role="status"></div>
          </div>
          <video [hidden]="!videoLoaded"
                 [src]="selectedMediaUrl"
                 (loadeddata)="videoLoaded = true"
                 controls autoplay muted
                 class="media-content">
          </video>
        </ng-container>

        <ng-container *ngIf="selectedMedia?.contentType?.startsWith('image')">
          <div *ngIf="!imageLoaded" class="loader-container">
             <div class="spinner-border text-primary" role="status"></div>
          </div>
          <img [hidden]="!imageLoaded"
               *ngIf="selectedMediaUrl"
               [src]="selectedMediaUrl"
               (load)="imageLoaded = true"
               alt="Podgląd"
               class="media-content">
        </ng-container>

      </div>
    </div>
  </div>
</div>

<!-- modal do edycji playlisty -->
<div class="modal fade show"
     *ngIf="showEditModal"
     [ngStyle]="{ display: 'block', background: 'rgba(0,0,0,0.5)' }"
     (click)="closeEditModal()">

  <div class="modal-dialog modal-dialog-centered modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-content border-0 shadow rounded-4 overflow-hidden">
      
      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold">Edytuj playlistę</h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>

      <div class="modal-body p-4">
        <div *ngIf="editError" class="alert alert-danger mb-3">{{ editError }}</div>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label small text-muted text-uppercase fw-bold">Nazwa</label>
            <input type="text" class="form-control modern-input" [(ngModel)]="editPlaylistData.name">
          </div>
          <div class="col-md-6">
             <label class="form-label small text-muted text-uppercase fw-bold">Opis</label>
             <input type="text" class="form-control modern-input" [(ngModel)]="editPlaylistData.description">
          </div>
        </div>
          
        <div class="col-12">
          <label class="form-label small text-muted text-uppercase fw-bold">Wybierz media</label>
          <div class="media-selection-list custom-scrollbar" style="max-height: 400px;">
              <div class="media-selection-item" *ngFor="let m of mediaList"
                   [class.selected]="isEditMediaSelected(m.id)"
                   (click)="toggleEditMediaSelection(m.id)">
                
                <div class="form-check pointer-events-none">
                  <input class="form-check-input" type="checkbox" [checked]="isEditMediaSelected(m.id)">
                </div>

                <div class="media-icon-placeholder rounded-3 d-flex align-items-center justify-content-center flex-shrink-0 ms-2"
                     style="width: 32px; height: 32px; font-size: 1rem;"
                     [ngClass]="m.contentType.startsWith('video') ? 'bg-primary-subtle text-primary' : 'bg-success-subtle text-success'">
                  <i class="bi" [ngClass]="m.contentType.startsWith('video') ? 'bi-play-circle-fill' : 'bi-image'"></i>
                </div>

                <div class="flex-grow-1 ms-3 overflow-hidden d-flex align-items-center justify-content-between pe-2">
                    <div style="min-width: 0;">
                        <div class="fw-semibold text-truncate small">{{ m.originalName }}</div>
                    </div>

                    <div *ngIf="isEditMediaSelected(m.id)" 
                         (click)="$event.stopPropagation()" 
                         class="d-flex align-items-center ms-2 animate-fade-in">
                      <input type="number" 
                             class="form-control form-control-sm modern-input text-center px-1" 
                             style="width: 60px; height: 28px; font-size: 0.8rem;"
                             placeholder="Auto"
                             min="1"
                             [ngModel]="getEditMediaDuration(m.id)"
                             (ngModelChange)="updateEditMediaDuration(m.id, $event)">
                      <span class="text-muted ms-1 small" style="font-size: 0.7rem;">s</span>
                    </div>
                </div>

                <button type="button" class="btn btn-sm btn-light text-secondary ms-1" 
                        (click)="openPopover($event, m)" title="Podgląd">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
          </div>
        </div>

      </div>

      <div class="modal-footer border-top-0 pt-0 pb-4 pe-4">
        <button class="btn btn-light" (click)="closeEditModal()">Anuluj</button>
        <button class="btn btn-primary" [disabled]="isSavingEdit" (click)="saveEditPlaylist()">Zapisz zmiany</button>
      </div>
    </div>
  </div>
</div>

<!-- popover do podgladu w edycie-->
<div class="media-popover"
     *ngIf="popover.visible"
     [style.top.px]="popover.y"
     [style.left.px]="popover.x"
     (click)="$event.stopPropagation()">
     
  <div class="popover-header-row d-flex justify-content-between align-items-start mb-2">
    <div class="small fw-bold text-truncate pe-2" style="max-width: 240px;">
      {{ popover.media?.originalName }}
    </div>
    <button type="button" class="btn-close small" aria-label="Close" (click)="closePopover()"></button>
  </div>

  <div class="popover-content text-center bg-light rounded overflow-hidden">
    
    <div *ngIf="popover.isLoading" class="py-4">
      <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
    </div>

    <ng-container *ngIf="!popover.isLoading && popover.url">
      
      <img *ngIf="popover.media?.contentType?.startsWith('image')" 
           [src]="popover.url" 
           alt="Podgląd"
           class="popover-media">

      <video *ngIf="popover.media?.contentType?.startsWith('video')" 
             [src]="popover.url" 
             autoplay [muted]="true" loop playsinline controls
             class="popover-media">
      </video>

    </ng-container>
  </div>
</div>

<!-- modal alert usuwania -->
<div class="modal fade show"
     *ngIf="showDeleteModal"
     [ngStyle]="{ display: 'block' }"
     style="background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);"
     (click)="closeDeleteModal()">

  <div class="modal-dialog modal-dialog-centered" style="max-width: 400px;" (click)="$event.stopPropagation()">
    <div class="modal-content border-0 strong-shadow rounded-4 overflow-hidden">
      
      <div class="modal-body p-4 text-center">
        <div class="mb-3 mx-auto d-flex align-items-center justify-content-center bg-danger-subtle text-danger rounded-circle" 
             style="width: 60px; height: 60px;">
          <i class="bi bi-exclamation-triangle-fill fs-3"></i>
        </div>

        <h5 class="fw-bold mb-2">Usunąć tą playlistę?</h5>
        <p class="text-muted small mb-4">
          Tej operacji nie można cofnąć. Playlista zostanie trwale usunięta, ale pliki w niej zawarte pozostaną w bibliotece.
        </p>

        <div class="d-grid gap-2">
          <button class="btn btn-danger py-2 fw-medium shadow-sm" 
                  (click)="confirmDelete()" 
                  [disabled]="isDeleting">
            <span *ngIf="isDeleting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            {{ isDeleting ? 'Usuwanie...' : 'Tak, usuń playlistę' }}
          </button>
          
          <button class="btn btn-light py-2 text-muted fw-medium" 
                  (click)="closeDeleteModal()"
                  [disabled]="isDeleting">
            Anuluj
          </button>
        </div>
      </div>

    </div>
  </div>
</div>
